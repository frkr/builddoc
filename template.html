<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation</title>
    
    <!-- GitHub Markdown CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    
    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <style>
        body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
            background-color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
        }
        
        .markdown-body {
            font-size: 16px;
            line-height: 1.5;
            color: #24292f;
        }
        
        .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .markdown-body h1 {
            font-size: 2em;
            border-bottom: 1px solid #d0d7de;
            padding-bottom: 0.3em;
        }
        
        .markdown-body h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #d0d7de;
            padding-bottom: 0.3em;
        }
        
        .markdown-body pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
        }
        
        .markdown-body code {
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 6px;
            padding: 0.2em 0.4em;
            font-size: 85%;
            font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
        }
        
        .markdown-body pre code {
            background-color: transparent;
            border-radius: 0;
            padding: 0;
        }
        
        .markdown-body table {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
            overflow: auto;
            margin: 16px 0;
        }
        
        .markdown-body table th, .markdown-body table td {
            border: 1px solid #d0d7de;
            padding: 6px 13px;
        }
        
        .markdown-body table th {
            background-color: #f6f8fa;
            font-weight: 600;
        }
        
        .markdown-body img {
            max-width: 100%;
            height: auto;
        }
        
        /* Badge styling */
        .markdown-body img[src*="img.shields.io"] {
            border-radius: 4px;
            margin: 2px 4px;
            vertical-align: middle;
        }
        
        /* Center alignment for header badges */
        .markdown-body div[align="center"] img[src*="img.shields.io"] {
            display: inline-block;
            margin: 4px 8px;
        }
        
        .markdown-body blockquote {
            border-left: 0.25em solid #d0d7de;
            color: #656d76;
            padding: 0 1em;
            margin: 0;
        }
        
        .markdown-body ul, .markdown-body ol {
            padding-left: 2em;
        }
        
        .markdown-body li {
            margin: 0.25em 0;
        }
        
        .markdown-body a {
            color: #0969da;
            text-decoration: none;
        }
        
        .markdown-body a:hover {
            text-decoration: underline;
        }
        
        /* Mermaid diagram styling */
        .mermaid {
            text-align: center;
            margin: 20px 0;
            background-color: #fff;
            border-radius: 6px;
            padding: 20px;
        }
        
        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #656d76;
        }
        
        /* Error styling */
        .error {
            background-color: #ffeef0;
            border: 1px solid #f85149;
            border-radius: 6px;
            padding: 16px;
            margin: 20px 0;
            color: #cf222e;
        }
        
        /* Print styles */
        @media print {
            @page {
                margin: 1cm;
                size: A4;
                @top-center { content: ""; }
                @bottom-center { content: ""; }
                @top-left { content: ""; }
                @top-right { content: ""; }
                @bottom-left { content: ""; }
                @bottom-right { content: ""; }
            }
            
            body {
                margin: 0;
                padding: 0;
            }
            
            .markdown-body {
                font-size: 12pt;
                line-height: 1.4;
            }
            
            .markdown-body h1 {
                font-size: 18pt;
                page-break-after: avoid;
            }
            
            .markdown-body h2 {
                font-size: 16pt;
                page-break-after: avoid;
            }
            
            .markdown-body h3 {
                font-size: 14pt;
                page-break-after: avoid;
            }
            
            .markdown-body pre {
                page-break-inside: avoid;
                font-size: 10pt;
            }
            
            .markdown-body table {
                page-break-inside: avoid;
            }
            
            .mermaid {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        ðŸ“„ Loading documentation...
    </div>
    
    <div class="markdown-body" id="content" style="display: none;">
        <!-- Content will be loaded here -->
    </div>
    
    <script>
        // Configuration
        const CONFIG = {
            markdownFile: 'synth.md',
            mermaidTheme: 'default',
            mermaidWaitTime: 3000
        };
        
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: CONFIG.mermaidTheme,
            themeVariables: {
                primaryColor: '#fff',
                primaryTextColor: '#000',
                primaryBorderColor: '#000',
                lineColor: '#000',
                secondaryColor: '#f0f0f0',
                tertiaryColor: '#fff'
            }
        });
        
        // Configure Marked.js with enhanced options
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                }
                return code;
            },
            breaks: true,
            gfm: true,
            pedantic: false,
            sanitize: false,
            smartLists: true,
            smartypants: false
        });
        
        // Custom renderer to handle image links properly
        const renderer = new marked.Renderer();
        
        // Override image rendering to handle badges properly
        renderer.image = function(href, title, text) {
            const titleAttr = title ? ` title="${title}"` : '';
            return `<img src="${href}" alt="${text}"${titleAttr} style="display: inline-block; margin: 2px;">`;
        };
        
        // Override link rendering to handle complex links
        renderer.link = function(href, title, text) {
            const titleAttr = title ? ` title="${title}"` : '';
            return `<a href="${href}"${titleAttr}>${text}</a>`;
        };
        
        marked.setOptions({ renderer: renderer });
        
        // Function to load and process markdown file
        async function loadMarkdownFile() {
            try {
                const response = await fetch(CONFIG.markdownFile);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const markdownText = await response.text();
                return markdownText;
            } catch (error) {
                console.error('Error loading markdown file:', error);
                throw error;
            }
        }
        
        // Function to process markdown and render HTML
        async function processMarkdown(markdownText) {
            try {
                // Convert markdown to HTML
                let htmlContent = marked.parse(markdownText);
                
                // Process Mermaid diagrams
                htmlContent = await processMermaidDiagrams(htmlContent);
                
                return htmlContent;
            } catch (error) {
                console.error('Error processing markdown:', error);
                throw error;
            }
        }
        
        // Function to process Mermaid diagrams
        async function processMermaidDiagrams(htmlContent) {
            // Find all mermaid code blocks
            const mermaidRegex = /```mermaid\n([\s\S]*?)\n```/g;
            let match;
            let diagramIndex = 0;
            
            while ((match = mermaidRegex.exec(htmlContent)) !== null) {
                const diagramCode = match[1].trim();
                const mermaidDiv = `<div class="mermaid" id="mermaid-${diagramIndex}">${diagramCode}</div>`;
                htmlContent = htmlContent.replace(match[0], mermaidDiv);
                diagramIndex++;
            }
            
            return htmlContent;
        }
        
        // Function to render Mermaid diagrams
        async function renderMermaidDiagrams() {
            const mermaidElements = document.querySelectorAll('.mermaid');
            
            for (let i = 0; i < mermaidElements.length; i++) {
                const element = mermaidElements[i];
                try {
                    // Generate unique ID for each diagram
                    const id = `mermaid-${i}-${Date.now()}`;
                    element.id = id;
                    
                    // Render the diagram
                    const { svg } = await mermaid.render(id, element.textContent);
                    element.innerHTML = svg;
                } catch (error) {
                    console.error(`Error rendering Mermaid diagram ${i}:`, error);
                    element.innerHTML = `<div class="error">Error rendering diagram: ${error.message}</div>`;
                }
            }
        }
        
        // Function to make URLs clickable
        function makeUrlsClickable(htmlContent) {
            const urlRegex = /(https?:\/\/[^\s<>"&]+)(?![^<]*<\/code>)(?![^<]*<\/pre>)/g;
            
            return htmlContent.replace(urlRegex, (match) => {
                // Remove trailing punctuation
                let url = match;
                while (url && url[-1] && '.,;:!?'.includes(url.slice(-1))) {
                    url = url.slice(0, -1);
                }
                return `<a href="${url}" target="_blank">${url}</a>`;
            });
        }
        
        // Main function to load and render content
        async function loadContent() {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                
                // Load markdown file
                const markdownText = await loadMarkdownFile();
                
                // Process markdown
                let htmlContent = await processMarkdown(markdownText);
                
                // Make URLs clickable
                htmlContent = makeUrlsClickable(htmlContent);
                
                // Set content
                document.getElementById('content').innerHTML = htmlContent;
                
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Render Mermaid diagrams
                await renderMermaidDiagrams();
                
                // Highlight code blocks
                Prism.highlightAll();
                
                console.log('Content loaded and rendered successfully');
                
            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('loading').innerHTML = 
                    `<div class="error">Error loading content: ${error.message}</div>`;
            }
        }
        
        // Initialize when DOM is loaded - DISABLED to prevent conflicts
        // document.addEventListener('DOMContentLoaded', function() {
        //     console.log('DOM loaded, starting content load...');
        //     loadContent();
        // });
        
        // Function to wait for all content to be ready (for PDF generation)
        window.waitForContentReady = function() {
            return new Promise((resolve) => {
                const checkReady = () => {
                    const loading = document.getElementById('loading');
                    const content = document.getElementById('content');
                    const mermaidElements = document.querySelectorAll('.mermaid');
                    
                    // Check if content is loaded and visible
                    if (loading.style.display === 'none' && 
                        content.style.display === 'block') {
                        
                        // Check if badges are rendered (not showing raw HTML)
                        const badges = content.querySelectorAll('img[src*="img.shields.io"]');
                        const hasBadges = badges.length > 0;
                        
                        // Check if Mermaid diagrams are rendered
                        let mermaidRendered = true;
                        if (mermaidElements.length > 0) {
                            mermaidElements.forEach(element => {
                                if (element.innerHTML.trim() === element.textContent.trim()) {
                                    mermaidRendered = false;
                                }
                            });
                        }
                        
                        // Wait for both badges and mermaid to be ready
                        if (hasBadges && mermaidRendered) {
                            console.log('All content ready for PDF generation');
                            resolve();
                            return;
                        }
                    }
                    
                    setTimeout(checkReady, 200);
                };
                
                checkReady();
            });
        };
        
        // Signal when everything is ready
        window.contentReady = false;
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                window.contentReady = true;
                console.log('Content ready signal set');
            }, 2000);
        });
    </script>
</body>
</html>
